---
title: "Diff-in-Diff 1: Simple DiD"
author: "Matt Birch"
date: "2023-02-25"
output: html_document
---

# Intro to Difference in Differences
### This one will be the simple version. More exciting videos to come!

```{r, message = FALSE, warning = FALSE}
rm(list = ls())
library(ggplot2)
library(stargazer)
```

The best approach to estimating causal impacts is with a randomized trial, such as with an A/B test. In many cases, however, randomization is either unfeasible or unethical, or both. Sometimes the real world conducts natural experiments, in which some people receive treatment while others do not. With careful analysis, we can exploit these natural experiments to identify the causal relationship. 

One of the most common methods is Difference in Differences, also called diff-in-diff or DiD. DiD is an empirical technique to exploit natural experiments to identify causal relationships. The general idea is that the data is separated into treatment and control groups, without us running a real experiment. Under certain assumptions, we can compare the treatment and control groups (one difference) before and after treatment occurs (another difference). We can see how the difference between groups changes, and find our causal effect. 

So let's get some [fake] data!

```{r}
stem_data <- read.csv("https://raw.githubusercontent.com/MattBirch42/Causal-Inference-Stuff/main/Fake_DD_stemPolicy_scores.csv")
```
### Explanation of Data
This is fake data about an imagined scenario that I used for a class assignment. The STEM program gives students in the participating region extra training in math and science. Not all regions participate. We will compare the test scores of students in participating regions those who are not before and after the program is implemented. 

Features:

* year = Year
* male = 1 if male, 0 otherwise
* Region: These represent some fictional geographic region
* Race: These categorize different unspecified races.
* Stem: stem denotes extra STEM prep in grades 10-12. Stem program starts in 2013 in region 2 and in 2015 in region 5. No other region has the program.
* bday_m_cutoff: regions 1-4 have compulsory schooling laws (save this for RD later)
* Education: parentâ€™s years of formal schooling
* Income: family income
* Score: Assessment exam score (this is our dependent variable)
* Varsity: did varsity sports
* single_parent_hh: Lives with single parent

I am going to ignore region 2 in this video, since it receives treatment ad a different time than region 5. We'll come back to region 2 in DiD part 3.That means that our treatment group in this video is region 5, and the control is everything else except region 2. 

```{r}
stem5 = stem_data[stem_data$region != 2,]
```

### Create plot to show the issue
Let's look at average scores in region 5 vs other regions combined.

Before 2015, Region 5 seems to lag behind the rest. Then in 2015, with the STEM program, scores in Region 5 jump to a higher level. With a good DiD, you can *see* the treatment in a graph like this. 

However, we still have to talk about assumptions and estimation. 

```{r, echo = FALSE}
stem5$reg5 = ifelse(stem5$region == 5,'Region 5','Other Regions')

avg_scores <- aggregate(score ~ reg5 + year, data = stem5, FUN = mean)

ggplot(avg_scores, aes(x = year, y = score, color = reg5)) +
  geom_point(size = 3) +
  labs(x = "Year", y = "Average Score", color = "Region") +
  theme_light()+
  geom_vline(xintercept = 2014.5, linetype = "dashed") +
  scale_x_continuous(breaks = seq(2010,2019, by = 1))

```

### Assumption
To successfully execute DiD and trust the results as a causal effect, you have to assume that the trends between treatment and control are parallel before and after the treatment. In this case, the trends do seem similar, before and after. 

```{r, echo = FALSE}
ggplot(avg_scores, aes(x = year, y = score, color = reg5)) +
  geom_line() +
  labs(x = "Year", y = "Average Score", color = "Region") +
  theme_light()+
  geom_vline(xintercept = 2014.5, linetype = "dashed") +
  scale_x_continuous(breaks = seq(2010,2019, by = 1))
```
###################################################################
# This is how we set up diff-in-diff. Requires at least 3 variables.
#     Dummy variable for treatment group
stem5$r2<-ifelse(stem5$region==2,1,0)
#     Dummy variable for if treatment is happening
stem5$y2013plus<-ifelse(stem5$year>=2013,1,0)
#     Interaction: the treatment group is being treated
stem5$r2_2013<-stem5$r2*stem5$y2013plus
###################################################################


dd_reg1 <- lm(score ~ r2_2013 + r2 + y2013plus, data = stem5)


#plot with regression lines added on for effect.

# with additional covariates

# stargazer for easy comparison

# inference
#inference
